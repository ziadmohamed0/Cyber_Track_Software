/*
 * dc_motor.cpp
 *
 *  Created on: Sep 4, 2025
 *      Author: ziad
 */
#include "dc_motor.h"

static DC_MOTOR* global_motor_instance = nullptr;


DC_MOTOR::DC_MOTOR(motor_cfg_t* cfg) :
					m_cfg(cfg),
					pin1(cfg->port, cfg->pins[0], GPIO_STATUS::OUTPUT_50MHz, GPIO_CONFIG::GP_PUSH_PULL),
					pin2(cfg->port, cfg->pins[1], GPIO_STATUS::OUTPUT_50MHz, GPIO_CONFIG::GP_PUSH_PULL),
					pwm(cfg->pwm_tim, 72-1, 1000-1, nullptr),
					position(0){
	global_motor_instance = this;
	this->pwm.pwm_init(this->m_cfg->pwm_channel);
	this->encA = new external_interrupt(this->m_cfg->port, this->m_cfg->pins[0], exti_trigger::RISING, this->encoderA_callback());
	this->encB = new external_interrupt(this->m_cfg->port, this->m_cfg->pins[1], exti_trigger::RISING, this->encoderB_callback());
}

void DC_MOTOR::move(motor_direction copy_direction) {
	switch (copy_direction) {
		case motor_direction::forward:
			this->pin1.set();
			this->pin2.clear();
			break;
		case motor_direction::reverse:
			this->pin1.clear();
			this->pin2.set();
			break;
		case motor_direction::stop:
			this->pin1.clear();
			this->pin2.clear();
			break;
		default:
			this->pin1.clear();
			this->pin2.clear();
			break;
	}
}

void DC_MOTOR::set_speed(uint32_t duty_percent){
	this->pwm.pwm_set_duty(this->m_cfg->pwm_channel, duty_percent);
}

void DC_MOTOR::stop() {
	this->move(motor_direction::stop);
	this->pwm.pwm_set_duty(this->m_cfg->pwm_channel, 0);
}

int32_t DC_MOTOR::get_position() {
	return this->position;
}

void DC_MOTOR::reset_position() {
	this->position = 0;
}



void DC_MOTOR::encoderA_callback() {
    if (global_motor_instance) global_motor_instance->handle_encoderA();
}

void DC_MOTOR::encoderB_callback() {
    if (global_motor_instance) global_motor_instance->handle_encoderB();
}

void DC_MOTOR::handle_encoderA() {
    // قراءة اتجاه من B
    if (gpio(m_cfg->enc_portB, m_cfg->enc_pinB, GPIO_STATUS::INPUT, GPIO_CONFIG::FLOATING).get())
        position++;
    else
        position--;
}

void DC_MOTOR::handle_encoderB() {
    // قراءة اتجاه من A
    if (gpio(m_cfg->enc_portA, m_cfg->enc_pinA, GPIO_STATUS::INPUT, GPIO_CONFIG::FLOATING).get())
        position--;
    else
        position++;
}
