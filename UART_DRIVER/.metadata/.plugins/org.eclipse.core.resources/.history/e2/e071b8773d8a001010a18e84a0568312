/*
 * tim.cpp
 *
 *  Created on: Sep 5, 2025
 *      Author: ziad
 */

#include "tim.h"


#include "timer.h"

timer::timer(TIM_TypeDef* tim, uint32_t prescaler, uint32_t arr, timer_callback_t cb)
    : instance(tim), callback(cb)
{
    // Enable clock
    if (tim == TIM2) RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;
    if (tim == TIM3) RCC->APB1ENR |= RCC_APB1ENR_TIM3EN;
    if (tim == TIM4) RCC->APB1ENR |= RCC_APB1ENR_TIM4EN;

    // Basic config
    instance->PSC = prescaler;
    instance->ARR = arr;
    instance->DIER |= TIM_DIER_UIE;  // Enable update interrupt
}

void timer::start() {
    instance->CR1 |= TIM_CR1_CEN;
}

void timer::stop() {
    instance->CR1 &= ~TIM_CR1_CEN;
}

void timer::handler() {
    if (instance->SR & TIM_SR_UIF) {
        instance->SR &= ~TIM_SR_UIF; // clear flag
        if (callback) callback();
    }
}
